- name: Install required packages
  block:
    - name: Install EPEL repository
      yum:
        name: epel-release
        state: present
      tags: install
      become: yes
    
    - name: Update yum cache
      yum:
        update_cache: yes
      tags: install
      become: yes
    
    - name: Install other packages
      yum:
        name:
          - nginx
          - wget
          - tar
        state: present
      tags: install
      become: yes
  tags: install
  become: yes

- name: Create directories
  file:
    path: "{{ item }}"
    state: directory
    owner: nginx
    group: nginx
    mode: '0755'
  loop:
    - "{{ lighthouse_install_dir }}"
    - "/var/log/nginx/lighthouse"
  tags: setup
  become: yes

- name: Download Lighthouse from GitHub
  get_url:
    url: "https://github.com/VKCOM/lighthouse/archive/refs/heads/master.tar.gz"
    dest: "/tmp/lighthouse.tar.gz"
    validate_certs: no
    timeout: 30
  tags: lighthouse
  become: yes

- name: Extract Lighthouse
  unarchive:
    src: "/tmp/lighthouse.tar.gz"
    dest: "{{ lighthouse_install_dir }}"
    remote_src: yes
    extra_opts: "--strip-components=1"
    creates: "{{ lighthouse_install_dir }}/index.html"
  tags: lighthouse
  become: yes

- name: Set permissions
  file:
    path: "{{ lighthouse_install_dir }}"
    owner: nginx
    group: nginx
    mode: '0755'
    recurse: yes
  tags: lighthouse
  become: yes

- name: Configure Nginx
  template:
    src: "lighthouse.conf.j2"
    dest: "/etc/nginx/conf.d/lighthouse.conf"
    owner: nginx
    group: nginx
    mode: '0644'
  notify: restart nginx
  tags: nginx
  become: yes

- name: Configure ClickHouse connection
  copy:
    dest: "{{ lighthouse_install_dir }}/clickhouse.config.js"
    content: |
      // ClickHouse configuration
      module.exports = {
        host: '{{ clickhouse_host }}',
        port: {{ clickhouse_port }},
        protocol: 'http',
        user: '{{ clickhouse_user }}',
        password: '{{ clickhouse_password }}',
        database: '{{ clickhouse_database }}'
      }
    owner: nginx
    group: nginx
    mode: '0644'
  tags: lighthouse
  become: yes

- name: Start and enable Nginx
  service:
    name: nginx
    state: started
    enabled: yes
  tags: nginx
  become: yes

- name: Configure firewall using firewall-cmd
  shell: |
    if command -v firewall-cmd >/dev/null 2>&1 && systemctl is-active firewalld >/dev/null 2>&1; then
        firewall-cmd --permanent --add-service=http
        firewall-cmd --reload
        echo "Firewall configured for HTTP"
    else
        echo "Firewalld not available or not active, skipping"
    fi
  args:
    executable: /bin/bash
  when: ansible_os_family == "RedHat"
  tags: firewall
  become: yes
  changed_when: false

- name: Verify installation
  shell: |
    echo "=== Lighthouse Installation Verification ==="
    echo "Directory: {{ lighthouse_install_dir }}"
    ls -la {{ lighthouse_install_dir }} | head -5
    echo ""
    echo "Nginx config test:"
    nginx -t 2>&1 || true
    echo ""
    echo "Nginx status:"
    systemctl is-active nginx
  args:
    executable: /bin/bash
  changed_when: false
  tags: verify
  become: yes